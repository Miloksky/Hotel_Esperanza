<div class="reservations-container">
  <div class="title">
    <h3>Editar mi reserva</h3>
  </div>
  <aside class="reservation-summary actual-reservation">
    <h3>reserva actual</h3>
    <div class="reservation-details">
      <div class="reservation-info">
        <p>Desde: {{ checkInDate }}</p>
        <p>Hasta: {{ checkOutDate }}</p>
        <p>Huéspedes: {{ guests }}</p>
        <p><strong>Total:</strong> {{ totalOfReservation()}} €</p>
      </div>
      <div class="reservation-rooms-list">
        @for (room of selectedRoom; track room.id) {
        <div class="reservation-room">
          <p>Habitación: {{ room.room_number }} - {{ room.type }} - {{room.price}} €/noche</p>
          <p>Plan de estancia:
            @if (room.resource_id) {
            {{ room.resource_name }} (+{{ room.resource_price }} €/noche)
            } @else {
            Ninguno
            }
          </p>
          
          <p>Subtotal: {{ room.subtotal }} €</p>
        </div>
        }
         @if (!editMode) {
      <button type="button" (click)="editMode = true">Modificar datos de la reserva</button>
      }
       @if (editMode) {
      <form class="edit-dates-form">
        <label>Desde:
          <input type="date" [(ngModel)]="editCheckInDate" name="editCheckInDate" [min]="today" required />
        </label>
        <label>Hasta:
          <input type="date" [(ngModel)]="editCheckOutDate" name="editCheckOutDate" [min]="minCheckOutDate()"
            required />
        </label>
        <label>Huéspedes:
          <input type="number" [(ngModel)]="editGuests" name="editGuests" min="1" required />
        </label>
        <button type="button" (click)="findRooms()">Guardar cambios</button>
        <button type="button" (click)="cancelEdition(reservationId)">Cancelar</button>
        @if (editDatesError) {
        <p style="color: #d84343;">{{ editDatesError }}</p>
        }
      </form>
      }
      </div>
    </div>
  </aside>
  <div class="main-content">
    <div class="rooms-grid">

      @if (roomsAvailable.length <= 0){ <h3>{{erroMsg}} </h3>
        }

        @if (roomsAvailable.length > 0) {
        @for (room of roomsAvailable; track room.id) {
        <div class="room-card">
          <h3>Habitación {{ room.number }} - {{ room.type }}</h3>
          <p>{{ room.description }}</p>
          <p>Precio: {{ room.price }} €</p>
          <p>Capacidad: {{ room.capacity }} personas</p>
          @if (showRoomResources === room.number) {
          <div class="resource-options">
            <label>Selecciona tu plan de estancia:</label>
            <div>
              <input type="radio" [name]="'resource_' + room.id" [value]="null"
                (change)="editSelectedResources[room.id] = null" [checked]="!editSelectedResources[room.id]" />
              Ninguno (solo habitación)
            </div>
            @if (roomResources[room.id]) {
            @for (resource of roomResources[room.id]; track resource.id) {
            <div>
              <input type="radio" [name]="'resource_' + room.id" [value]="resource.id"
                (change)="editSelectedResources[room.id] = resource.id"
                [checked]="editSelectedResources[room.id] === resource.id" />
              {{ resource.name }} (+{{ resource.price }}€/noche)
            </div>
            }
            }
            <button type="button" (click)="showRoomResources = null">
              Ocultar opciones
            </button>
          </div>
          }

          @if (showRoomResources !== room.number) {
          <button type="button" (click)="showRoomResources = room.number">
            Mostrar opciones de plan
          </button>
          }

          <button type="button" (click)="addRoom(room)">Añadir</button>
        </div>
        }}

    </div>


    @if (editRooms.length > 0) {
    <aside class="reservation-summary">
      <h3>Resumen de los cambios</h3>

      @if (editDatesError) {
      <p style="color: #d84343; margin-top: 6px; font-weight: bold;">
        {{ editDatesError }}
      </p>
      }

      @if (editRooms.length > 0) {

      <!-- Lista de habitaciones nuevas/seleccionadas en la edición -->
      @for (room of editRooms; track room.id) {
      <div class="summary-room-card">
        <p><strong>Habitación:</strong> {{ room.number }} - {{ room.type }}</p>
        <p><strong>Precio base:</strong> {{ room.price }} €/noche</p>
        <p><strong>Capacidad:</strong> {{ room.capacity }} personas</p>

        <!-- Plan de estancia elegido -->
        @if (roomResources[room.id]) {
        @if (editSelectedResources[room.id]) {
        @for (resource of roomResources[room.id]; track resource.id) {
        @if (resource.id === editSelectedResources[room.id]) {
        <p>
          <strong>Plan:</strong> {{ resource.name }} (+{{ resource.price }}€/noche)
        </p>
        }
        }
        } @else {
        <p><strong>Plan:</strong> Ninguno</p>
        }
        } @else {
        <p><strong>Plan:</strong> Ninguno</p>
        }

        <!-- Botón para quitar habitación -->
        <button type="button" (click)="removeRoom(room)">eliminar</button>
      </div>
      }

      <!-- Fechas y huéspedes -->
      <p><strong>Desde:</strong> {{ editCheckInDate }}</p>
      <p><strong>Hasta:</strong> {{ editCheckOutDate }}</p>
      <p><strong>Huéspedes:</strong> {{ editGuests }}</p>
      <p><strong>Capacidad total:</strong> {{ getTotalCapacity() }}</p>
      <p><strong>Total:</strong> {{ calculateNewTotal()}} €</p>

      <!-- Error si capacidad < huéspedes -->
      @if (getTotalCapacity() < editGuests) { <p style="color: red">
        <strong>¡No hay suficientes camas para todos los huéspedes!</strong>
        </p>
        }

        <!-- Botón para confirmar cambios (edición) -->
        <button type="button" (click)="saveChanges()" [disabled]="!editRooms.length || getTotalCapacity() < editGuests">
          Guardar cambios
        </button>

        } @else {
        <!-- SOLO FECHAS SI NO HAY HABITACIONES EN EDICIÓN -->
        <p><strong>Desde:</strong> {{ editCheckInDate }}</p>
        <p><strong>Hasta:</strong> {{ editCheckOutDate }}</p>
        <p><strong>Huéspedes:</strong> {{ editGuests }}</p>
        <p style="opacity: 0.6; font-style: italic">
          No hay habitaciones seleccionadas para la edición.
        </p>
        }
    </aside>}

  </div>

</div>